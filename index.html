<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B-drive | Cloud Management Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root { 
            --bdrive-dark: #020617; 
            --bdrive-navy: #0f172a; 
            --bdrive-cyan: #06b6d4; 
            --bdrive-blue: #3b82f6; 
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b; 
            overflow-x: hidden; 
        }

        .glass-panel { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); 
            border-bottom: 1px solid rgba(226, 232, 240, 0.8); 
        }

        .sidebar-item-active { 
            background: linear-gradient(90deg, rgba(6, 182, 212, 0.12) 0%, rgba(6, 182, 212, 0) 100%); 
            border-left: 4px solid var(--bdrive-cyan); 
            color: var(--bdrive-cyan); 
            font-weight: 700; 
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .modal-overlay { background: rgba(2, 6, 23, 0.8); backdrop-filter: blur(6px); z-index: 100; }
        
        .sidebar-mobile {
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar-mobile.open {
            transform: translateX(0);
        }

        .chart-container { position: relative; height: 260px; width: 100%; }
        .notes-textarea { resize: none; scrollbar-width: thin; transition: all 0.3s ease; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const API_BASE_URL = "https://bdrive-admin-api.smartpasses.workers.dev"; 

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [services, setServices] = useState([]);
            const [quotes, setQuotes] = useState([]);
            const [selectedService, setSelectedService] = useState(null);
            const [selectedQuote, setSelectedQuote] = useState(null);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [message, setMessage] = useState(null);
            const [searchQuery, setSearchQuery] = useState("");
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 8;

            const chartRef1 = useRef(null);
            const chartRef2 = useRef(null);

            useEffect(() => { fetchInitialData(); }, []);

            useEffect(() => {
                if (!loading) {
                    const timer = setTimeout(() => {
                        if (window.lucide) window.lucide.createIcons();
                        if (view === 'dashboard' && quotes.length > 0) renderCharts();
                    }, 300);
                    return () => clearTimeout(timer);
                }
            }, [view, services, selectedService, loading, quotes]);

            const fetchInitialData = async () => {
                setLoading(true);
                try {
                    const [qRes, sRes] = await Promise.all([
                        fetch(`${API_BASE_URL}/api/quotes`),
                        fetch(`${API_BASE_URL}/api/services`)
                    ]);
                    if (qRes.ok) setQuotes(await qRes.json());
                    if (sRes.ok) setServices(await sRes.json());
                } catch (err) {
                    setMessage({ text: "Error de red: Worker inaccesible", type: "error" });
                } finally {
                    setLoading(false);
                }
            };

            const renderCharts = () => {
                const ctx1 = document.getElementById('leadsChart');
                const ctx2 = document.getElementById('serviceChart');
                if (ctx1) {
                    if (chartRef1.current) chartRef1.current.destroy();
                    const dailyData = quotes.reduce((acc, q) => {
                        const date = q.fecha ? q.fecha.split('T')[0] : 'N/A';
                        acc[date] = (acc[date] || 0) + 1;
                        return acc;
                    }, {});
                    const labels = Object.keys(dailyData).sort().slice(-7);
                    chartRef1.current = new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{ label: 'Leads', data: labels.map(l => dailyData[l]), borderColor: '#06b6d4', backgroundColor: 'rgba(6, 182, 212, 0.1)', fill: true, tension: 0.4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });
                }
                if (ctx2) {
                    if (chartRef2.current) chartRef2.current.destroy();
                    const serviceData = quotes.reduce((acc, q) => {
                        acc[q.servicio || "Otros"] = (acc[q.servicio || "Otros"] || 0) + 1;
                        return acc;
                    }, {});
                    chartRef2.current = new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(serviceData),
                            datasets: [{ data: Object.values(serviceData), backgroundColor: ['#06b6d4', '#3b82f6', '#8b5cf6', '#f43f5e', '#10b981'], borderWidth: 0 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, cutout: '75%' }
                    });
                }
            };

            const handlePriceUpdate = (matrixKey, value) => {
                if (!selectedService) return;
                const updated = JSON.parse(JSON.stringify(selectedService));
                const val = parseFloat(value) || 0;
                if (updated.matriz_precios?.[matrixKey]?.precio) {
                    updated.matriz_precios[matrixKey].precio.monto = val;
                } else if (updated.planes?.[matrixKey]) {
                    updated.planes[matrixKey].precio_mensual = val;
                }
                setSelectedService(updated);
            };

            const handleProjectRuleUpdate = (field, value) => {
                if (!selectedService) return;
                const updated = JSON.parse(JSON.stringify(selectedService));
                if (field === 'regla_calculo') updated.regla_calculo = value;
                if (field === 'costo_diario' && updated.costos_recursos?.ingeniero_senior) {
                    updated.costos_recursos.ingeniero_senior.costo_diario = parseFloat(value) || 0;
                }
                setSelectedService(updated);
            };

            const handleRawJsonUpdate = (value) => {
                try {
                    const parsed = JSON.parse(value);
                    setSelectedService(parsed);
                } catch(e) { /* Error de sintaxis temporal mientras el usuario escribe */ }
            };

            const deleteLead = async (id) => {
                if (!confirm("¿Eliminar este lead de la base de datos?")) return;
                try {
                    const res = await fetch(`${API_BASE_URL}/api/quotes/${id}`, { method: 'DELETE' });
                    if (res.ok) setQuotes(quotes.filter(q => q.id !== id));
                } catch (e) { setMessage({ text: "Error al borrar", type: "error" }); }
            };

            const saveChanges = async () => {
                if (!selectedService) return;
                setSaving(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/services/${selectedService.servicio_id}`, { 
                        method: 'PUT', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(selectedService) 
                    });
                    if (res.ok) {
                        setMessage({ text: "Sincronización exitosa", type: "success" });
                        setServices(services.map(s => s.servicio_id === selectedService.servicio_id ? selectedService : s));
                    }
                } catch (err) { setMessage({ text: "Error de sincronización", type: "error" }); }
                finally { setSaving(false); setTimeout(() => setMessage(null), 3000); }
            };

            const stats = useMemo(() => {
                const total = quotes.reduce((acc, q) => acc + (q.monto || 0), 0);
                return { total, count: quotes.length, avg: quotes.length > 0 ? (total / quotes.length).toFixed(0) : 0 };
            }, [quotes]);

            const filteredQuotes = useMemo(() => {
                return quotes.filter(q => (q.cliente || "").toLowerCase().includes(searchQuery.toLowerCase()) || (q.servicio || "").toLowerCase().includes(searchQuery.toLowerCase()));
            }, [quotes, searchQuery]);

            const currentLeads = filteredQuotes.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
            const totalPages = Math.ceil(filteredQuotes.length / itemsPerPage);

            const getServiceIcon = (s) => {
                const id = (s?.servicio_id || "").toLowerCase();
                if (s?.categoria === 'infraestructura') return 'activity';
                if (s?.categoria === 'seguridad' || id.includes('pentesting')) return 'shield';
                if (id.includes('correo') || id.includes('google')) return 'mail';
                if (id.includes('nube') || id.includes('gcp')) return 'cloud';
                return 'package';
            };

            const getMotorName = (s) => {
                if (!s) return "Cargando...";
                if (s.matriz_precios) return "Matriz de Escalamiento";
                if (s.regla_calculo) return "Algoritmo de Proyecto";
                if (s.planes) return "Suscripción por Planes";
                return "Estructura Personalizada";
            };

            if (loading) return (
                <div className="h-screen w-full flex flex-col items-center justify-center bg-slate-900 text-white font-bold">
                    <div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="opacity-50 uppercase tracking-widest text-[10px]">Autenticando B-drive Core...</p>
                </div>
            );

            return (
                <div className="flex h-screen overflow-hidden relative bg-[#f8fafc]">
                    {/* Sidebar Desktop */}
                    <aside className="hidden lg:flex w-72 bg-slate-900 text-slate-300 flex flex-col border-r border-slate-800 z-30">
                        <div className="p-8 flex items-center space-x-3">
                            <div className="bg-cyan-500 p-2.5 rounded-2xl shadow-lg shadow-cyan-500/20"><i data-lucide="zap" className="w-6 h-6 text-white"></i></div>
                            <div><h1 className="text-xl font-extrabold text-white tracking-tight leading-none">B-drive</h1><span className="text-[9px] text-cyan-400 font-black uppercase tracking-[0.2em]">Admin Console</span></div>
                        </div>
                        <nav className="flex-1 px-4 space-y-1 overflow-y-auto custom-scrollbar pt-4">
                            <button onClick={() => setView('dashboard')} className={`w-full flex items-center space-x-3 px-4 py-3.5 rounded-xl transition-all ${view === 'dashboard' ? 'sidebar-item-active text-white bg-slate-800/50' : 'hover:bg-slate-800/30'}`}>
                                <i data-lucide="layout-dashboard" className="w-5 h-5"></i><span className="font-semibold text-sm">Dashboard Global</span>
                            </button>
                            <button onClick={() => { setView('quotes'); setCurrentPage(1); }} className={`w-full flex items-center space-x-3 px-4 py-3.5 rounded-xl transition-all ${view === 'quotes' ? 'sidebar-item-active text-white bg-slate-800/50' : 'hover:bg-slate-800/30'}`}>
                                <i data-lucide="file-text" className="w-5 h-5"></i><span className="font-semibold text-sm">Leads y Auditoría</span>
                            </button>
                            <div className="pt-8 pb-3 px-5 font-bold text-[10px] text-slate-500 uppercase tracking-[0.15em]">Gestión de Precios</div>
                            {services.map(s => (
                                <button key={s.servicio_id} onClick={() => { setSelectedService(s); setView('editor'); }} className={`w-full flex items-center justify-between px-4 py-3 rounded-xl transition-all group ${selectedService?.servicio_id === s.servicio_id && view === 'editor' ? 'sidebar-item-active text-white bg-slate-800/50' : 'hover:bg-slate-800/30'}`}>
                                    <div className="flex items-center space-x-3">
                                        <i data-lucide={getServiceIcon(s)} className="w-4 h-4 opacity-70 group-hover:opacity-100"></i>
                                        <span className="text-sm font-medium">{s.nombre_corto || s.nombre}</span>
                                    </div>
                                    <i data-lucide="chevron-right" className={`w-3 h-3 transition-transform ${selectedService?.servicio_id === s.servicio_id ? 'rotate-90 opacity-100' : 'opacity-0 group-hover:opacity-40'}`}></i>
                                </button>
                            ))}
                        </nav>
                        <div className="p-8 border-t border-slate-800 flex items-center space-x-3 text-[10px] opacity-40 font-bold uppercase italic"><div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div><span>Sync Online</span></div>
                    </aside>

                    {/* Mobile Menu */}
                    {isSidebarOpen && <div className="lg:hidden fixed inset-0 z-[60] bg-black/70 backdrop-blur-sm" onClick={() => setIsSidebarOpen(false)}></div>}
                    <aside className={`fixed inset-y-0 left-0 z-[70] w-72 bg-slate-900 text-slate-300 flex flex-col border-r border-slate-800 sidebar-mobile ${isSidebarOpen ? 'open' : ''} lg:hidden`}>
                        <div className="p-8 flex items-center justify-between border-b border-slate-800">
                            <h1 className="text-xl font-black text-white">B-drive</h1>
                            <button onClick={() => setIsSidebarOpen(false)} className="text-slate-400 p-2"><i data-lucide="x" className="w-6 h-6"></i></button>
                        </div>
                        <nav className="flex-1 px-4 space-y-1 pt-6 overflow-y-auto">
                            <button onClick={() => { setView('dashboard'); setIsSidebarOpen(false); }} className={`w-full flex items-center space-x-4 px-5 py-4 rounded-2xl ${view === 'dashboard' ? 'sidebar-item-active bg-slate-800' : ''}`}><i data-lucide="layout-dashboard" className="w-5 h-5"></i><span>Dashboard</span></button>
                            <button onClick={() => { setView('quotes'); setIsSidebarOpen(false); }} className={`w-full flex items-center space-x-4 px-5 py-4 rounded-2xl ${view === 'quotes' ? 'sidebar-item-active bg-slate-800' : ''}`}><i data-lucide="file-text" className="w-5 h-5"></i><span>Leads</span></button>
                            {services.map(s => (
                                <button key={s.servicio_id} onClick={() => { setSelectedService(s); setView('editor'); setIsSidebarOpen(false); }} className={`w-full flex items-center space-x-4 px-5 py-4 rounded-2xl ${selectedService?.servicio_id === s.servicio_id && view === 'editor' ? 'sidebar-item-active bg-slate-800' : ''}`}><i data-lucide={getServiceIcon(s)} className="w-4 h-4"></i><span>{s.nombre_corto || s.nombre}</span></button>
                            ))}
                        </nav>
                    </aside>

                    <main className="flex-1 flex flex-col min-w-0 bg-[#f8fafc] overflow-hidden">
                        <header className="h-20 glass-panel px-6 md:px-10 flex items-center justify-between z-10 sticky top-0">
                            <div className="flex items-center space-x-4">
                                <button onClick={() => setIsSidebarOpen(true)} className="lg:hidden p-2.5 text-slate-600 bg-white rounded-xl shadow-sm border border-slate-200"><i data-lucide="menu" className="w-6 h-6"></i></button>
                                <h2 className="text-sm md:text-lg font-bold text-slate-800 truncate uppercase tracking-[0.1em] font-black">
                                    {view === 'quotes' ? 'Historial Comercial' : view === 'dashboard' ? 'Performance Global' : selectedService?.nombre}
                                </h2>
                            </div>
                            <div className="flex items-center space-x-2 md:space-x-5">
                                <button onClick={fetchInitialData} className="p-2.5 text-slate-400 hover:text-cyan-600 bg-white rounded-xl shadow-sm border border-slate-100 hover:border-cyan-200 active:rotate-180 transition-all"><i data-lucide="refresh-cw" className="w-4 md:w-5 h-4 md:h-5"></i></button>
                                <div className="h-10 w-10 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-black shadow-xl border-2 border-slate-800">B</div>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-10 custom-scrollbar">
                            {message && (
                                <div className={`animate-fade-in mb-8 p-4.5 rounded-2xl flex items-center shadow-2xl ${message.type === 'success' ? 'bg-emerald-500 text-white' : 'bg-rose-500 text-white'}`}>
                                    <i data-lucide={message.type === 'success' ? 'check-circle' : 'alert-circle'} className="w-5 h-5 mr-3 shrink-0"></i><span className="font-bold text-xs md:text-sm tracking-tight">{message.text}</span>
                                </div>
                            )}

                            {view === 'dashboard' && (
                                <div className="animate-fade-in space-y-8">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 md:gap-8">
                                        {[
                                            { t: "Ingresos Proyectados", v: `$${Number(stats.total).toLocaleString()}`, c: "text-cyan-600" },
                                            { t: "Leads Totales", v: stats.count, c: "text-slate-800" },
                                            { t: "Ticket Promedio", v: `$${Number(stats.avg).toLocaleString()}`, c: "text-indigo-600" },
                                            { t: "Estado Worker", v: "ONLINE", c: "text-emerald-500" }
                                        ].map((card, i) => (
                                            <div key={i} className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm transition-all hover:shadow-xl hover:shadow-cyan-500/5 hover:-translate-y-1">
                                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.15em] mb-2">{card.t}</p>
                                                <h3 className={`text-2xl md:text-3xl font-black ${card.c} tracking-tight`}>{card.v}</h3>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                        <div className="bg-white p-7 md:p-10 rounded-[3rem] border border-slate-100 shadow-sm min-h-[400px]">
                                            <h4 className="text-sm font-black text-slate-800 mb-10 flex items-center uppercase tracking-widest"><i data-lucide="trending-up" className="w-5 h-5 mr-3 text-cyan-500"></i> Tendencia Semanal</h4>
                                            <div className="chart-container"><canvas id="leadsChart"></canvas></div>
                                        </div>
                                        <div className="bg-white p-7 md:p-10 rounded-[3rem] border border-slate-100 shadow-sm min-h-[400px]">
                                            <h4 className="text-sm font-black text-slate-800 mb-10 flex items-center uppercase tracking-widest"><i data-lucide="pie-chart" className="w-5 h-5 mr-3 text-indigo-500"></i> Mix de Soluciones</h4>
                                            <div className="chart-container"><canvas id="serviceChart"></canvas></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'quotes' && (
                                <div className="animate-fade-in space-y-6">
                                    <div className="bg-white p-6 md:p-8 rounded-[2.5rem] border border-slate-100 shadow-sm flex flex-col sm:flex-row gap-5">
                                        <div className="relative flex-1">
                                            <i data-lucide="search" className="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                            <input type="text" placeholder="Filtrar por empresa o ID..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-12 pr-6 py-4 bg-slate-50 rounded-[1.5rem] border-none outline-none focus:ring-4 focus:ring-cyan-500/10 text-sm font-medium" />
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-[2.5rem] border border-slate-100 overflow-hidden shadow-sm overflow-x-auto custom-scrollbar">
                                        <table className="w-full text-left min-w-[850px]">
                                            <thead><tr className="bg-slate-50/70 border-b border-slate-100"><th className="p-7 text-[10px] font-black text-slate-400 uppercase tracking-widest">Prospecto / ID</th><th className="p-7 text-[10px] font-black text-slate-400 uppercase tracking-widest">Solución</th><th className="p-7 text-[10px] font-black text-slate-400 uppercase tracking-widest text-right">Inversión</th><th className="p-7 text-[10px] font-black text-slate-400 uppercase tracking-widest text-center">Gestión</th></tr></thead>
                                            <tbody className="divide-y divide-slate-50">
                                                {currentLeads.map(q => (
                                                    <tr key={q.id} className="hover:bg-slate-50/40 transition-all">
                                                        <td className="p-7"><p className="text-sm font-extrabold text-slate-800">{q.cliente}</p><p className="text-[10px] text-slate-400 mt-1 font-mono uppercase">{q.id.substring(0,18)}...</p></td>
                                                        <td className="p-7 text-sm font-semibold text-slate-500">{q.servicio}</td>
                                                        <td className="p-7 text-sm font-black text-right">${(q.monto || 0).toLocaleString()} <span className="text-[9px] opacity-40 ml-1 uppercase">MXN</span></td>
                                                        <td className="p-7 text-center space-x-2">
                                                            <button onClick={() => setSelectedQuote(q)} className="p-2.5 text-slate-300 hover:text-cyan-600 hover:bg-white border border-transparent hover:border-cyan-100 rounded-xl transition-all shadow-sm"><i data-lucide="edit-3" className="w-4 h-4"></i></button>
                                                            <button onClick={() => deleteLead(q.id)} className="p-2.5 text-slate-300 hover:text-rose-600 hover:bg-white border border-transparent hover:border-rose-100 rounded-xl transition-all shadow-sm"><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        <div className="p-7 border-t border-slate-50 flex justify-between items-center bg-slate-50/30">
                                            <p className="text-[11px] text-slate-400 font-extrabold uppercase tracking-widest">Página {currentPage} de {totalPages || 1}</p>
                                            <div className="flex items-center space-x-2">
                                                <button onClick={() => setCurrentPage(p => Math.max(1, p-1))} disabled={currentPage === 1} className="p-2.5 rounded-xl bg-white border border-slate-200 disabled:opacity-30"><i data-lucide="chevron-left" className="w-4 h-4"></i></button>
                                                <button onClick={() => setCurrentPage(p => Math.min(totalPages, p+1))} disabled={currentPage === totalPages || totalPages === 0} className="p-2.5 rounded-xl bg-white border border-slate-200 disabled:opacity-30"><i data-lucide="chevron-right" className="w-4 h-4"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {selectedQuote && (
                                <div className="fixed inset-0 z-[100] flex items-center justify-center p-3 md:p-6 modal-overlay animate-fade-in">
                                    <div className="bg-white w-full max-w-3xl rounded-[2.5rem] md:rounded-[4rem] shadow-2xl overflow-hidden flex flex-col max-h-[95vh] sm:max-h-[92vh]">
                                        <div className="p-8 md:p-12 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                            <div className="min-w-0 flex-1"><h3 className="text-xl md:text-2xl font-black text-slate-900 truncate tracking-tight">Expediente de Lead</h3><p className="text-[10px] text-cyan-600 font-black mt-2 uppercase tracking-[0.25em] truncate">REF: {selectedQuote.id}</p></div>
                                            <button onClick={() => setSelectedQuote(null)} className="ml-6 p-3 hover:bg-white rounded-[1.5rem] text-slate-400 hover:text-slate-900 transition-all border border-transparent hover:border-slate-200"><i data-lucide="x" className="w-6 h-6"></i></button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-8 md:p-12 space-y-10 custom-scrollbar text-left">
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 md:gap-10">
                                                <div className="bg-slate-50 p-8 rounded-[2.5rem] border border-slate-100">
                                                    <p className="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-[0.15em]">Entidad Comercial</p>
                                                    <input type="text" value={selectedQuote.cliente || ""} onChange={(e) => setSelectedQuote({...selectedQuote, cliente: e.target.value})} className="bg-transparent border-none p-0 font-black text-slate-800 text-xl w-full focus:ring-0" placeholder="Nombre..." />
                                                </div>
                                                <div className="bg-cyan-50 p-8 rounded-[2.5rem] border border-cyan-100 shadow-inner">
                                                    <p className="text-[10px] font-black text-cyan-500 uppercase mb-3 tracking-[0.15em]">Valor Estimado</p>
                                                    <p className="text-2xl md:text-3xl font-black text-cyan-700 tracking-tight">${(selectedQuote.monto || 0).toLocaleString()} <span className="text-xs">MXN</span></p>
                                                </div>
                                            </div>
                                            <div className="space-y-5">
                                                <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center px-2"><i data-lucide="message-square" className="w-4 h-4 mr-3 text-cyan-500"></i> Bitácora de Seguimiento</h4>
                                                <textarea className="w-full h-40 md:h-52 p-8 bg-slate-50 rounded-[2.5rem] border-2 border-transparent outline-none focus:border-cyan-500/20 text-sm text-slate-600 font-medium notes-textarea shadow-inner transition-all leading-relaxed" placeholder="Registra llamadas, correos o acuerdos..." value={selectedQuote.anotaciones || ""} onChange={(e) => setSelectedQuote({...selectedQuote, anotaciones: e.target.value})}></textarea>
                                            </div>
                                            <div>
                                                <h4 className="text-[10px] font-black text-slate-400 uppercase mb-5 tracking-widest flex items-center px-2"><i data-lucide="terminal" className="w-3.5 h-3.5 mr-3 text-indigo-500"></i> Datos Técnicos Capturados</h4>
                                                <div className="bg-slate-900 rounded-[2.5rem] p-8 font-mono text-[10px] text-cyan-400/80 shadow-2xl overflow-x-auto leading-loose border-2 border-slate-800/50"><pre>{JSON.stringify(selectedQuote.entradas_usuario, null, 2)}</pre></div>
                                            </div>
                                        </div>
                                        <div className="p-8 md:p-12 border-t border-slate-100 flex flex-col sm:flex-row justify-between bg-slate-50/50 gap-6">
                                            <button onClick={() => deleteLead(selectedQuote.id)} className="order-2 sm:order-1 px-6 py-4 text-rose-500 font-black text-[10px] uppercase tracking-widest hover:bg-rose-50 rounded-2xl transition-all flex items-center justify-center sm:justify-start"><i data-lucide="trash-2" className="w-4.5 h-4.5 mr-3"></i>Borrar Registro</button>
                                            <div className="order-1 sm:order-2 flex space-x-3 sm:space-x-4">
                                                <button onClick={() => setSelectedQuote(null)} className="flex-1 sm:flex-none px-10 py-4 bg-white text-slate-400 font-black rounded-2xl text-[10px] uppercase tracking-widest border border-slate-200 shadow-sm hover:bg-slate-50 transition-all">Cancelar</button>
                                                <button onClick={saveQuoteNotes} disabled={saving} className="flex-1 sm:flex-none px-12 py-4 bg-slate-900 text-white font-black rounded-2xl text-[10px] uppercase tracking-widest shadow-2xl hover:bg-slate-800 transition-all flex items-center justify-center">{saving ? <div className="animate-spin h-4 w-4 border-2 border-white/30 border-t-white rounded-full mr-3"></div> : <i data-lucide="save" className="w-4 h-4 mr-3"></i>}Actualizar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'editor' && selectedService && (
                                <div className="animate-fade-in max-w-5xl mx-auto space-y-8 md:space-y-12">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-8">
                                        <div className="min-w-0 flex-1">
                                            <h3 className="text-2xl md:text-4xl font-black text-slate-900 tracking-tighter leading-tight">{selectedService.nombre}</h3>
                                            <div className="flex flex-wrap gap-3 mt-4">
                                                <span className="bg-cyan-50 text-cyan-600 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-[0.1em] border border-cyan-100">ID: {selectedService.servicio_id}</span>
                                                <span className="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-[0.1em] border border-slate-200">Motor: {getMotorName(selectedService)}</span>
                                            </div>
                                        </div>
                                        <button onClick={saveChanges} disabled={saving} className="w-full sm:w-auto bg-cyan-500 text-white px-10 md:px-14 py-4 md:py-5 rounded-[2rem] font-black text-xs uppercase tracking-[0.2em] shadow-2xl shadow-cyan-500/30 hover:bg-cyan-400 transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center">{saving ? <div className="animate-spin h-4 w-4 border-2 border-white/30 border-t-white rounded-full mr-3"></div> : <i data-lucide="cloud-lightning" className="w-5 h-5 mr-4"></i>}Sincronizar KV</button>
                                    </div>

                                    {/* MODO MATRIZ (NOC/SOC/CONTACT CENTER) */}
                                    {selectedService.matriz_precios && (
                                        <div className="grid grid-cols-1 gap-8 md:gap-12">
                                            {['8x5', '7x24'].map(horario => (
                                                <div key={horario} className="bg-white rounded-[3rem] md:rounded-[4rem] p-8 md:p-12 border border-slate-100 shadow-sm relative overflow-hidden">
                                                    <div className="absolute -top-10 -right-10 opacity-5 pointer-events-none"><i data-lucide="clock" className="w-48 h-48"></i></div>
                                                    <h4 className="text-[11px] font-black text-slate-900 uppercase mb-10 md:mb-14 flex items-center tracking-[0.3em] relative z-10"><i data-lucide="clock" className="w-5 h-5 mr-4 text-cyan-500"></i>Esquema Operativo: {horario}</h4>
                                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-10 relative z-10">
                                                        {['bajo', 'medio', 'alto'].map(volumen => {
                                                            const key = `${horario}_${volumen}`;
                                                            const item = selectedService.matriz_precios[key];
                                                            if (!item) return null;
                                                            return (
                                                                <div key={volumen} className="bg-slate-50/60 rounded-[2rem] md:rounded-[2.5rem] p-8 md:p-10 border border-slate-100 hover:bg-white transition-all group shadow-sm hover:shadow-2xl hover:shadow-cyan-500/10 text-center">
                                                                    <label className="text-[9px] font-black text-slate-400 uppercase block mb-6 tracking-widest uppercase">Carga {volumen}</label>
                                                                    <div className="relative">
                                                                        <span className="absolute left-0 top-1/2 -translate-y-1/2 text-slate-300 font-black text-2xl">$</span>
                                                                        <input type="number" value={item.precio?.monto || 0} onChange={(e) => handlePriceUpdate(key, e.target.value)} className="w-full pl-8 pr-4 bg-transparent border-none outline-none text-2xl md:text-3xl font-black text-slate-800 text-center focus:ring-0 transition-all" />
                                                                    </div>
                                                                    <p className="text-[9px] text-slate-400 mt-6 font-extrabold italic tracking-widest uppercase opacity-60 leading-none">{item.precio?.unidad}</p>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {/* MODO PROYECTO (PENTESTING) */}
                                    {selectedService.regla_calculo && (
                                        <div className="bg-white rounded-[3rem] md:rounded-[4rem] p-8 md:p-12 border border-slate-100 shadow-sm space-y-10 md:space-y-14 relative overflow-hidden">
                                            <div className="absolute top-0 right-0 p-12 opacity-5 pointer-events-none"><i data-lucide="cpu" className="w-40 h-40"></i></div>
                                            <h4 className="text-[11px] font-black text-slate-900 uppercase flex items-center tracking-[0.3em] relative z-10"><i data-lucide="cpu" className="w-6 h-6 mr-4 text-cyan-500"></i>Parámetros del Algoritmo Pro</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-10 md:gap-14 relative z-10">
                                                <div className="space-y-6">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase block tracking-[0.2em]">Fórmula Operativa (Días base + extra)</label>
                                                    <input type="text" value={selectedService.regla_calculo || ""} onChange={(e) => handleProjectRuleUpdate('regla_calculo', e.target.value)} className="w-full px-8 py-5 md:py-6 bg-slate-50 rounded-[2rem] border-2 border-transparent focus:border-cyan-500/20 outline-none text-xl md:text-2xl font-black text-slate-800 shadow-inner focus:bg-white transition-all shadow-sm" />
                                                    <div className="p-4 bg-amber-50/50 rounded-2xl border border-amber-100/50"><p className="text-[10px] text-amber-700 italic font-bold leading-relaxed">{selectedService.explicacion_regla}</p></div>
                                                </div>
                                                <div className="space-y-6">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase block tracking-[0.2em]">Honorarios Día Ing. Senior (MXN)</label>
                                                    <div className="relative">
                                                        <span className="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300 font-black text-2xl">$</span>
                                                        <input type="number" value={selectedService.costos_recursos?.ingeniero_senior?.costo_diario || 0} onChange={(e) => handleProjectRuleUpdate('costo_diario', e.target.value)} className="w-full pl-14 pr-8 py-5 md:py-6 bg-slate-50 rounded-[2rem] border-2 border-transparent focus:border-cyan-500/20 outline-none text-xl md:text-2xl font-black text-slate-800 shadow-inner focus:bg-white transition-all shadow-sm" />
                                                    </div>
                                                    <div className="bg-indigo-50 border border-indigo-100 p-5 rounded-2xl flex items-center justify-between">
                                                        <span className="text-[10px] text-indigo-700 font-black uppercase tracking-widest">Multiplicador Retesting</span>
                                                        <span className="text-lg font-black text-indigo-800">x{selectedService.retesting?.multiplicador || 2}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* MODO PLANES (WORKSPACE / NUBE GCP) */}
                                    {selectedService.planes && (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-10">
                                            {Object.keys(selectedService.planes).map(pId => (
                                                <div key={pId} className="bg-white rounded-[2.5rem] md:rounded-[3.5rem] p-8 md:p-10 border border-slate-100 shadow-sm hover:border-cyan-200 transition-all group flex flex-col min-h-[350px] relative overflow-hidden">
                                                    <span className="text-[9px] font-black text-cyan-600 bg-cyan-50 px-4 py-2 rounded-full uppercase tracking-widest w-fit mb-8 border border-cyan-100 relative z-10">{pId}</span>
                                                    <h4 className="text-xl md:text-2xl font-black text-slate-800 mb-10 leading-tight tracking-tight relative z-10 truncate">{selectedService.planes[pId].nombre}</h4>
                                                    <div className="flex-1 space-y-8 relative z-10">
                                                        <div className="bg-slate-50 p-6 md:p-8 rounded-[2.5rem] shadow-inner transition-colors group-hover:bg-slate-50/40">
                                                            <label className="text-[9px] font-black text-slate-400 uppercase block mb-2 tracking-widest uppercase">Fee Mensual</label>
                                                            <div className="relative">
                                                                <span className="absolute left-0 top-1/2 -translate-y-1/2 text-slate-300 font-black text-3xl">$</span>
                                                                <input type="number" value={selectedService.planes[pId].precio_mensual || 0} onChange={(e) => handlePriceUpdate(pId, e.target.value)} className="w-full pl-8 bg-transparent border-none outline-none text-3xl md:text-4xl font-black text-slate-800 focus:ring-0 transition-all" />
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <div className="bg-slate-50/50 p-4 rounded-2xl border border-slate-100 text-center"><p className="text-[8px] font-black text-slate-400 uppercase tracking-widest uppercase">Espacio</p><p className="text-xs font-bold text-slate-700 mt-1">{selectedService.planes[pId].almacenamiento || '---'}</p></div>
                                                            <div className="bg-slate-50/50 p-4 rounded-2xl border border-slate-100 text-center"><p className="text-[8px] font-black text-slate-400 uppercase tracking-widest uppercase">Meet</p><p className="text-xs font-bold text-slate-700 mt-1">{selectedService.planes[pId].participantes_meet ? `${selectedService.planes[pId].participantes_meet} pax` : '---'}</p></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {/* MODO FALLBACK: EDITOR DE JSON (Para estructuras nuevas desconocidas) */}
                                    {!selectedService.matriz_precios && !selectedService.regla_calculo && !selectedService.planes && (
                                        <div className="bg-white rounded-[3rem] p-10 border border-slate-100 shadow-sm space-y-6">
                                            <div className="bg-amber-50 border border-amber-200 p-6 rounded-[2rem] flex items-start space-x-4">
                                                <i data-lucide="alert-circle" className="text-amber-500 w-6 h-6"></i>
                                                <div>
                                                    <h5 className="font-black text-amber-900 uppercase text-xs tracking-widest">Esquema Desconocido Detectado</h5>
                                                    <p className="text-amber-700 text-xs mt-1 leading-relaxed">Este servicio tiene una estructura de datos nueva que el panel aún no sabe cómo dibujar visualmente. Puedes editar el JSON crudo directamente abajo para actualizar los valores en Cloudflare KV sin romper nada.</p>
                                                </div>
                                            </div>
                                            <textarea 
                                                className="w-full h-[450px] p-10 bg-slate-900 text-cyan-400 font-mono text-xs rounded-[3rem] border-none outline-none focus:ring-4 focus:ring-cyan-500/10 custom-scrollbar leading-loose"
                                                value={JSON.stringify(selectedService, null, 2)}
                                                onChange={(e) => handleRawJsonUpdate(e.target.value)}
                                            ></textarea>
                                        </div>
                                    )}

                                    <div className="bg-slate-900 text-white p-8 md:p-12 rounded-[3rem] md:rounded-[4rem] shadow-2xl flex flex-col md:flex-row items-center justify-between gap-8">
                                        <div className="flex items-center space-x-6">
                                            <div className="p-4 bg-cyan-500/10 rounded-[1.5rem] border border-cyan-500/20"><i data-lucide="shield-check" className="w-8 h-8 text-cyan-400"></i></div>
                                            <div>
                                                <h5 className="text-lg font-black tracking-tight leading-none uppercase tracking-widest">Consola Cloud Sincronizada</h5>
                                                <p className="text-slate-400 text-xs md:text-sm mt-3 leading-relaxed max-w-md">Cualquier cambio guardado se propagará a través de la red global de Cloudflare en milisegundos, actualizando la lógica de todos los agentes B-drive.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
